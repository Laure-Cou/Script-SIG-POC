<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers with GeoServer</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v6.5.0/css/ol.css">
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
    <script src="https://openlayers.org/en/v6.5.0/build/ol.js"></script>
    <script>
        // Définir la projection EPSG:2154
        proj4.defs('EPSG:2154', '+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
        ol.proj.proj4.register(proj4);

        var projectionLambert = ol.proj.get('EPSG:2154');

        // Configuration de la carte
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                projection: projectionLambert,
                center: ol.proj.fromLonLat([2.3522, 48.8566], projectionLambert), // Paris, France
                zoom: 6
            })
        });
        var currentView = map.getView();
        var currentProjection = currentView.getProjection();

        // Configuration de la source WMS de GeoServer
        var wmsSource = new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/wms',
            params: {
                'LAYERS': 'espace:bretelles',
                'TILED': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
        });

        // Ajouter la couche WMS à la carte
        var wmsLayer = new ol.layer.Tile({
            source: wmsSource
        });
        map.addLayer(wmsLayer);

        // Configuration de la source de dessin
        const drawSource = new ol.source.Vector();

        // Configuration de la couche de dessin
        const drawLayer = new ol.layer.Vector({
            source: drawSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'blue'
                    })
                })
            })
        });
        map.addLayer(drawLayer);

        // Configuration de l'interaction de dessin
        const draw = new ol.interaction.Draw({
            source: drawSource,
            type: 'Point'
        });
        map.addInteraction(draw);

        // Ajouter un écouteur d'événements pour capturer les dessins terminés
        draw.on('drawend', function(event) {
            const coordinates = event.feature.getGeometry().getCoordinates();
            console.log('Dessin terminé:', coordinates);

            // Créer une requête WFS-T pour insérer une nouvelle fonctionnalité
            const wfsTransaction = `
                <wfs:Transaction service="WFS" version="1.1.0"
                    xmlns:wfs="http://www.opengis.net/wfs"
                    xmlns:gml="http://www.opengis.net/gml"
                    xmlns:espace="http://espace"
                    xmlns:ogc="http://www.opengis.net/ogc">
                    <wfs:Insert>
                        <espace:bretelles>
                            <espace:geom>
                                <gml:Point srsName="EPSG:2154">
                                    <gml:pos>${coordinates[0]} ${coordinates[1]}</gml:pos>
                                </gml:Point>
                            </espace:geom>
                        </espace:bretelles>
                    </wfs:Insert>
                </wfs:Transaction>
            `;

            // Envoyer la requête WFS-T à GeoServer
            fetch('http://localhost:8081/geoserver/wfs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/xml'
                },
                body: wfsTransaction
            })
            .then(response => response.text())
            .then(data => {
                console.log('Réponse WFS-T:', data);
                // Rafraîchir la couche WMS pour voir les nouvelles fonctionnalités
                wmsSource.updateParams({'time': Date.now()});
            })
            .catch(error => {
                console.error('Erreur lors de la requête WFS-T:', error);
            });
        });
    </script>
</body>
</html>