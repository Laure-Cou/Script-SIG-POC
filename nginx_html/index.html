<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers with GeoServer</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v6.5.0/css/ol.css">
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        #insertButton, #deleteButton {
            position: absolute;
            top: 10px;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        #deleteButton {
            right: 10px;
        }
        #insertButton {
            right: 130px;
        }
        #deleteButton.active {
            background-color: #dc3545;
        }
        .ol-overlaycontainer-stopevent {
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="insertButton">Insert Point</button>
    <button id="deleteButton">Delete Points</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
    <script src="https://openlayers.org/en/v6.5.0/build/ol.js"></script>
    <script>
        // Définir la projection EPSG:2154
        proj4.defs('EPSG:2154', '+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
        ol.proj.proj4.register(proj4);

        var projectionLambert = ol.proj.get('EPSG:2154');

        // Configuration de la carte
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                projection: projectionLambert,
                center: ol.proj.fromLonLat([2.3522, 48.8566], projectionLambert), // Paris, France
                zoom: 6
            })
        });
        var currentView = map.getView();
        var currentProjection = currentView.getProjection();

        // Configuration de la source WMS de GeoServer
        var wmsSource = new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/wms',
            params: {
                'LAYERS': 'espace:bretelles',
                'TILED': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
        });

        // Ajouter la couche WMS à la carte
        var wmsLayer = new ol.layer.Tile({
            source: wmsSource
        });
        map.addLayer(wmsLayer);

        // Configuration de la source de dessin
        const drawSource = new ol.source.Vector();

        // Configuration de la couche de dessin
        const drawLayer = new ol.layer.Vector({
            source: drawSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'blue'
                    })
                })
            })
        });
        map.addLayer(drawLayer);

        // Configuration de l'interaction de dessin
        const draw = new ol.interaction.Draw({
            source: drawSource,
            type: 'Point'
        });

        // Désactiver l'interaction de dessin par défaut
        draw.setActive(false);
        map.addInteraction(draw);

        // Ajouter un écouteur d'événements pour capturer les dessins terminés
        draw.on('drawend', function(event) {
            const coordinates = event.feature.getGeometry().getCoordinates();
            console.log('Dessin terminé:', coordinates);

            // Créer une requête WFS-T pour insérer une nouvelle fonctionnalité
            const wfsTransaction = `
                <wfs:Transaction service="WFS" version="1.1.0"
                    xmlns:wfs="http://www.opengis.net/wfs"
                    xmlns:gml="http://www.opengis.net/gml"
                    xmlns:espace="http://espace"
                    xmlns:ogc="http://www.opengis.net/ogc">
                    <wfs:Insert>
                        <espace:bretelles>
                            <espace:geom>
                                <gml:Point srsName="EPSG:2154">
                                    <gml:pos>${coordinates[0]} ${coordinates[1]}</gml:pos>
                                </gml:Point>
                            </espace:geom>
                        </espace:bretelles>
                    </wfs:Insert>
                </wfs:Transaction>
            `;

            // Envoyer la requête WFS-T à GeoServer
            fetch('http://localhost:8081/geoserver/wfs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/xml'
                },
                body: wfsTransaction
            })
            .then(response => response.text())
            .then(data => {
                console.log('Réponse WFS-T:', data);
                // Rafraîchir la couche WMS pour voir les nouvelles fonctionnalités
                wmsSource.updateParams({'time': Date.now()});

                // Supprimer le point bleu de la carte
                drawSource.clear();

                // Recharger la carte après l'insertion
                setTimeout(() => {
                    wmsSource.refresh();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur lors de la requête WFS-T:', error);
            });

            // Désactiver l'interaction de dessin après l'insertion
            draw.setActive(false);
        });

        // Configuration de la source vectorielle pour la sélection
        const selectSource = new ol.source.Vector();

        // Configuration de la couche vectorielle pour la sélection
        const selectLayer = new ol.layer.Vector({
            source: selectSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'red'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 2
                    })
                })
            })
        });
        map.addLayer(selectLayer);

        // Configuration de l'interaction de sélection
        const select = new ol.interaction.Select({
            layers: [selectLayer],
            hitTolerance: 50000 // 50 km
        });
        map.addInteraction(select);

        // Désactiver l'interaction de sélection par défaut
        select.setActive(false);

        // Ajouter un écouteur d'événements pour capturer les sélections
        select.on('select', function(event) {
            console.log('Sélection:', event);
            const selectedFeatures = event.selected;
            if (selectedFeatures.length > 0) {
                const feature = selectedFeatures[0];
                const coordinates = feature.getGeometry().getCoordinates();
                console.log('Point sélectionné:', coordinates);

                // Créer une requête WFS-T pour supprimer la fonctionnalité
                const wfsTransaction = `
                    <wfs:Transaction service="WFS" version="1.1.0"
                        xmlns:wfs="http://www.opengis.net/wfs"
                        xmlns:gml="http://www.opengis.net/gml"
                        xmlns:espace="http://espace"
                        xmlns:ogc="http://www.opengis.net/ogc">
                        <wfs:Delete typeName="espace:bretelles">
                            <ogc:Filter>
                                <ogc:Intersects>
                                    <ogc:PropertyName>geom</ogc:PropertyName>
                                    <gml:Point srsName="EPSG:2154">
                                        <gml:pos>${coordinates[0]} ${coordinates[1]}</gml:pos>
                                    </gml:Point>
                                </ogc:Intersects>
                            </ogc:Filter>
                        </wfs:Delete>
                    </wfs:Transaction>
                `;

                // Envoyer la requête WFS-T à GeoServer
                fetch('http://localhost:8081/geoserver/wfs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/xml'
                    },
                    body: wfsTransaction
                })
                .then(response => response.text())
                .then(data => {
                    console.log('Réponse WFS-T:', data);
                    // Rafraîchir la couche WMS pour voir les nouvelles fonctionnalités
                    wmsSource.refresh();
                })
                .catch(error => {
                    console.error('Erreur lors de la requête WFS-T:', error);
                });

                // Désactiver l'interaction de sélection après la suppression
                select.setActive(false);
                document.getElementById('deleteButton').classList.remove('active');
                map.getViewport().style.cursor = '';
            }
        });

        // Ajouter un écouteur d'événements pour le bouton d'insertion
        document.getElementById('insertButton').addEventListener('click', function() {
            // Activer l'interaction de dessin
            draw.setActive(true);
        });

        // Fonction pour générer des coordonnées aléatoires dans les limites de la carte
        function generateRandomCoordinates(extent) {
            const [minX, minY, maxX, maxY] = extent;
            const randomX = minX + Math.random() * (maxX - minX);
            const randomY = minY + Math.random() * (maxY - minY);
            return [randomX, randomY];
        }

        // Fonction pour générer les coordonnées des points à supprimer
        function generatePointsToDelete(features, numPoints) {
            const points = [];
            const featureIndices = Array.from({ length: features.length }, (_, i) => i);
            for (let i = 0; i < numPoints; i++) {
                const randomIndex = Math.floor(Math.random() * featureIndices.length);
                const feature = features[featureIndices[randomIndex]];
                const coordinates = feature.getGeometry().getCoordinates();
                points.push(coordinates);
                featureIndices.splice(randomIndex, 1); // Remove the selected feature from the list
            }
            return points;
        }

        // Fonction pour créer une animation colorée autour des points
        function animatePoints(points) {
            const animationLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 10,
                        fill: new ol.style.Fill({
                            color: 'rgba(128, 0, 128, 0.5)' // Violet clignotant
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'rgba(128, 0, 128, 1)',
                            width: 2
                        })
                    })
                })
            });
            map.addLayer(animationLayer);

            points.forEach(coordinates => {
                const feature = new ol.Feature(new ol.geom.Point(coordinates));
                animationLayer.getSource().addFeature(feature);
            });

            // Animation de clignotement
            let opacity = 1;
            const interval = setInterval(() => {
                opacity = opacity === 1 ? 0.5 : 1;
                animationLayer.getSource().getFeatures().forEach(feature => {
                    feature.getStyle().getImage().getFill().setColor(`rgba(128, 0, 128, ${opacity})`);
                });
                animationLayer.changed();
            }, 500);

            // Arrêter l'animation après 5 secondes
            setTimeout(() => {
                clearInterval(interval);
                map.removeLayer(animationLayer);
            }, 5000);
        }

        // Ajouter un écouteur d'événements pour le bouton de suppression
        document.getElementById('deleteButton').addEventListener('click', function() {
            const wfsUrl = 'http://localhost:8081/geoserver/wfs?service=WFS&version=1.1.0&request=GetFeature&typeName=espace:bretelles&outputFormat=application/json';

            fetch(wfsUrl)
            .then(response => response.json())
            .then(data => {
                const features = new ol.format.GeoJSON().readFeatures(data);
                selectSource.clear();
                selectSource.addFeatures(features);

                const numPoints = 5; // Nombre de points à supprimer
                const pointsToDelete = generatePointsToDelete(features, numPoints);

                // Animer les points avant de les supprimer
                animatePoints(pointsToDelete);

                // Supprimer les points après l'animation
                setTimeout(() => {
                    pointsToDelete.forEach(coordinates => {
                        const wfsTransaction = `
                            <wfs:Transaction service="WFS" version="1.1.0"
                                xmlns:wfs="http://www.opengis.net/wfs"
                                xmlns:gml="http://www.opengis.net/gml"
                                xmlns:espace="http://espace"
                                xmlns:ogc="http://www.opengis.net/ogc">
                                <wfs:Delete typeName="espace:bretelles">
                                    <ogc:Filter>
                                        <ogc:Intersects>
                                            <ogc:PropertyName>geom</ogc:PropertyName>
                                            <gml:Point srsName="EPSG:2154">
                                                <gml:pos>${coordinates[0]} ${coordinates[1]}</gml:pos>
                                            </gml:Point>
                                        </ogc:Intersects>
                                    </ogc:Filter>
                                </wfs:Delete>
                            </wfs:Transaction>
                        `;

                        // Envoyer la requête WFS-T à GeoServer
                        fetch('http://localhost:8081/geoserver/wfs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/xml'
                            },
                            body: wfsTransaction
                        })
                        .then(response => response.text())
                        .then(data => {
                            console.log('Réponse WFS-T:', data);
                            // Rafraîchir la couche WMS pour voir les nouvelles fonctionnalités
                            wmsSource.refresh();
                        })
                        .catch(error => {
                            console.error('Erreur lors de la requête WFS-T:', error);
                        });
                    });

                    // Actualiser la carte après la suppression de tous les points
                    setTimeout(() => {
                        wmsSource.refresh();
                    }, 1000);
                }, 5000);
            })
            .catch(error => {
                console.error('Erreur lors de la requête WFS:', error);
            });
        });
    </script>
</body>
</html>